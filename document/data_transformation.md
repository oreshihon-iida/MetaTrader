# データ変換と保存機能

## 概要

このドキュメントでは、FXトレードシステムのデータ変換と保存機能について説明します。この機能により、生データ（1分足）から複数の時間足（15分足、1時間足など）にリサンプリングし、テクニカル指標やサポート/レジスタンスレベルを計算して保存することができます。

## 機能

1. **複数時間足への変換**
   - 1分足データから15分足、1時間足へのリサンプリング
   - 各時間足ごとにテクニカル指標を計算
   - サポート/レジスタンスレベルの検出

2. **データの保存と再利用**
   - 処理済みデータをCSVファイルとして保存
   - 年ごと、時間足ごとに整理されたディレクトリ構造
   - バックテスト時に処理済みデータを再利用して高速化

3. **サポート/レジスタンスレベル検出**
   - スイングポイント（高値/安値）の検出
   - 類似価格帯のクラスタリングによるレベル特定
   - 直近の重要レベルの優先順位付け

## ディレクトリ構造

```
data/
├── raw/                  # 生データ（ZIPファイル）
└── processed/            # 処理済みデータ
    ├── 15min/            # 15分足データ
    │   ├── 2000/         # 2000年のデータ
    │   │   └── USDJPY_15min_2000.csv
    │   ├── 2001/
    │   │   └── USDJPY_15min_2001.csv
    │   └── ...
    └── 1H/               # 1時間足データ
        ├── 2000/
        │   └── USDJPY_1H_2000.csv
        ├── 2001/
        │   └── USDJPY_1H_2001.csv
        └── ...
```

## 使用方法

### データの変換と保存

```bash
python transform_data.py
```

このスクリプトは、`data/raw`ディレクトリ内の全ての年のデータを処理し、15分足と1時間足に変換して`data/processed`ディレクトリに保存します。

### 処理済みデータの使用

バックテストスクリプト（`main.py`や`yearly_backtest.py`）は、自動的に処理済みデータの読み込みを試みます。処理済みデータが見つからない場合は、生データから処理を行います。

## サポート/レジスタンスレベル検出アルゴリズム

サポート/レジスタンスレベルの検出は以下のステップで行われます：

1. **スイングポイントの検出**
   - 指定されたウィンドウサイズ内で、前後の価格より高い/低い点を特定
   - 閾値以上の価格変動がある点のみを選択

2. **レベルのクラスタリング**
   - 類似した価格帯のスイングポイントをグループ化
   - 各クラスターの平均値を代表的なレベルとして採用

3. **重要レベルの選択**
   - 現在の価格に近いレベルを優先的に選択
   - 上位3つのサポートレベルと3つのレジスタンスレベルを記録

## パフォーマンス最適化

データ処理のパフォーマンスを最適化するために、以下の手法を採用しています：

1. **並列処理**
   - 複数の年のデータを同時に処理
   - CPUコア数に基づいて最適なプロセス数を自動設定

2. **データキャッシング**
   - 処理済みデータをCSVファイルとして保存
   - バックテスト時に再計算を回避

3. **効率的なデータ構造**
   - 年ごとのデータ分割による効率的なメモリ使用
   - 必要な期間のデータのみを読み込み
